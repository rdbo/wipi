# Contributor: Rdbo <rdbodev@gmail.com>
# Maintainer: Rdbo <rdbodev@gmail.com>
pkgname=rpi-boot
pkgver="1.0_git$(date +"%Y%m%d")"
pkgrel=0
pkgdesc="Stubs for booting the Raspberry Pi (Bootloader, DTBs, Kernel, Modules)"
url="https://github.com/raspberrypi/firmware"
arch="noarch"
license="Broadcom,GPL-2.0"
options="!check"
_commit="55c0555f30b4ff1ad20a3dd4db535b0d013c0a40"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/raspberrypi/firmware/archive/$_commit.tar.gz
	"

build() {
	return 0
}

package() {
	local wrkdir="$srcdir/$pkgname-$_commit"
	install -D "$wrkdir/boot/." "$pkgdir/boot/"
	install -D "$wrkdir/extra/." "$pkgdir/boot/"
	install -D "$wrkdir"/modules/*v8+ "$pkgdir/usr/lib/modules/"

	# Raspberry Pi 4B uses kernel8.img; clean up files that are unused
	find "$pkgdir/boot/" -type f -maxdepth 1 -name "kernel*.img" ! -name "kernel8.img" -delete
	find "$pkgdir/boot/" -type f -maxdepth 1 -name "*.dtb" ! -name "bcm2711-rpi-4-b.dtb" -delete
	find "$pkgdir/boot/" -type f -maxdepth 1 -name "*.symvers" ! -name "Module8.symvers" -delete
	find "$pkgdir/boot/" -type f -maxdepth 1 -name "*.map" ! -name "System8.map"-delete
	find "$pkgdir/boot/" -type f -maxdepth 1 -name "uname_string*" ! -name "uname_string8"-delete

	# Generate kernel release to trigger initramfs generator
	mkdir -p "$pkgdir/usr/share/kernel/wipi"
	ls "$pkgdir/usr/lib/modules" | head -n 1 > "$pkgdir/usr/share/kernel/wipi/kernel.release"
}
